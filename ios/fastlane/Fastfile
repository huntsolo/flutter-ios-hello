# ios/fastlane/Fastfile

require "shellwords"

default_platform(:ios)

# ===== Configuration =====
APP_BUNDLE_ID    = "h-solo-test"
TEAM_ID          = "7JUQ5ZZTUS"
MATCH_GIT_BRANCH = "main"

ASC_KEY_ID       = "RLMFMY76AM"
ASC_ISSUER_ID    = "4420f5b4-46c7-4c02-a532-391041fe7c32"
ASC_KEY_PATH     = "./fastlane/AuthKey_RLMFMY76AM.p8"

GIT_REMOTE_NAME  = "origin"
TAG_PREFIX       = "ios"
# ========================

platform :ios do
  desc "Fetch signing, bump build, build IPA, upload to TestFlight, tag & push"
  lane :beta do
    project_root = File.expand_path("../..", __dir__) # Fastfile lives in ios/fastlane
    root_escaped = Shellwords.escape(project_root)

    setup_ci

    match(
      type: "appstore",
      readonly: true,
      app_identifier: [APP_BUNDLE_ID],
      git_branch: MATCH_GIT_BRANCH
    )

    automatic_code_signing(
      path: "Runner.xcodeproj",
      use_automatic_signing: true,
      team_id: TEAM_ID,
      targets: ["Runner"]
    )

    # Bump build BEFORE building
    increment_build_number(xcodeproj: "Runner.xcodeproj")
    version = get_version_number(xcodeproj: "Runner.xcodeproj", target: "Runner")
    build   = get_build_number(xcodeproj: "Runner.xcodeproj")
    UI.message("Building version #{version} (build #{build})")

    sh("flutter --version")
    sh("flutter clean")
    sh("flutter pub get")
    sh("flutter build ipa --release")

    ipa_candidates = Dir["#{project_root}/build/ios/ipa/*.ipa"]
    UI.user_error!("IPA(s) not found in #{project_root}/build/ios/ipa") if ipa_candidates.empty?
    ipa_path = ipa_candidates.max_by { |f| File.mtime(f) }
    UI.message("Uploading IPA: #{ipa_path}")

    # Git info for changelog
    sha = if File.directory?(File.join(project_root, ".git"))
            sh("git -C #{root_escaped} rev-parse --short HEAD").strip
          else
            "n/a"
          end

    # ASC API key from .p8
    api_key = app_store_connect_api_key(
      key_id: ASC_KEY_ID,
      issuer_id: ASC_ISSUER_ID,
      key_filepath: ASC_KEY_PATH,
      in_house: false
    )

    # Tag name used both in changelog and later tagging
    tag_name = "#{TAG_PREFIX}-v#{version}-b#{build}"

    # Upload to TestFlight (note the comma before changelog!)
    pilot(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "Tag: #{tag_name}\nCommit: #{sha}"
    )

    # Create and push git tag from repo root
    if ENV["SKIP_TAG"] == "1"
      UI.important("Skipping git tag: SKIP_TAG=1")
    elsif File.directory?(File.join(project_root, ".git"))
      # Ensure git identity (useful on CI)
      sh("git -C #{root_escaped} config user.email || git -C #{root_escaped} config user.email 'ci@local'")
      sh("git -C #{root_escaped} config user.name  || git -C #{root_escaped} config user.name  'CI'")

      # Optionally commit build bump (uncomment to persist)
      # sh(\"git -C #{root_escaped} add ios/Runner.xcodeproj/project.pbxproj && git -C #{root_escaped} commit -m #{Shellwords.escape("ci: bump build to #{build} [skip ci]")} || true\")

      msg = "fastlane ios beta v#{version} (#{build})"
      sh("git -C #{root_escaped} tag -a #{Shellwords.escape(tag_name)} -m #{Shellwords.escape(msg)} || true")
      sh("git -C #{root_escaped} push #{Shellwords.escape(GIT_REMOTE_NAME)} #{Shellwords.escape(tag_name)} || true")
      UI.success("Pushed tag #{tag_name} to #{GIT_REMOTE_NAME}")
    else
      UI.important("Skipping git tag: #{project_root} is not a git repository")
    end
  end

  desc "Create/refresh signing in the match repo (run locally)"
  lane :provision_all do
    match(type: "development", readonly: false, app_identifier: [APP_BUNDLE_ID], git_branch: MATCH_GIT_BRANCH)
    match(type: "appstore",    readonly: false, app_identifier: [APP_BUNDLE_ID], git_branch: MATCH_GIT_BRANCH)
  end
end
